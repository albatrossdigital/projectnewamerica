<?php
/**
 * @file
 * Code for the Reach slideshow widget feature.
 */

include_once 'reach_slideshow_panel_widget.features.inc';


/**
 * Implements hook_field_widget_form_alter().
 
function reach_slideshow_panel_widget_field_widget_form_alter(&$element, &$form_state, $context) {
  if($element['#field_name'] == 'field_view_renderer' && $element['#bundle'] == 'reach_slideshow_widget') {
    module_load_include('module', 'views');
    //$views = views_all_get_views();
    $views = views_get_views_as_options();
    $options = array();
    foreach($views as $key => $value) {
      if(strpos($key, 'slideshow_widget') === 0) {
        $o_key = substr($key, strpos($key, ':') + 1);
        $options[$o_key] = $views[$key];
      }
      else {
        continue;
      }
    }
    $element['#options'] = $options;
  }
}*/

/**
 * Implements hook_field_prepare_view().
 */
function reach_slideshow_panel_widget_theme($existing, $type, $theme, $path) {
  return array(
    'reach_slideshow_panel_widget' => array(
      'render element' => 'elements',
      'template'  => 'fieldable-panels-pane-reach-slideshow-panel-widget',
    ),
  );
}


/**
 * Implements hook_theme_registry_alter().

function reach_slideshow_panel_widget_theme_registry_alter(&$theme_registry) {
  //dpm($theme_registry);
} */


/**
 * Add a class for our bundle to the normal panels pane theme.
 */
function reach_slideshow_panel_widget_preprocess_panels_pane(&$vars) {
  if ($vars['pane']->type == 'fieldable_panels_pane' && $vars['content']['#bundle'] == 'reach_slideshow_widget') {
    $vars['content']['#theme'] = 'reach_slideshow_panel_widget';
    $vars['theme_hook_suggestions'][] = 'panels_pane__fieldable_panels_pane_reach_slideshow_panel_widget';
    $view_display = $vars['content']['field_view_renderer']['#items'][0]['value'];
    $view = views_embed_view('slideshow_widget', $view_display, array($vars['content']['field_slideshow']['#object']->fpid));
    $view = str_replace('/#', '#', $view);
    $vars['content']['reach_rendered_view'] = $view;
  }
}


function reach_slideshow_panel_widget_example_block_info() {

  $blocks['example'] = array(
    // info: The name of the block.
    'info' => t('Example: uppercase this please'), 
    'status' => TRUE, 
    'region' => 'sidebar_first', // Not usually provided.
  );

  return $blocks;
}

function block_example_block_view($delta = '') {
  //The $delta parameter tells us which block is being requested.
  switch ($delta) {
    case 'example':
      // The subject is displayed at the top of the block. Note that it
      // should be passed through t() for translation. The title configured
      // for the block using Drupal UI supercedes this one.
      $block['subject'] = t('Title of first block (example_configurable_text)');
      // The content of the block is typically generated by calling a custom
      // function.
      $block['content'] = views_embed_view('slideshow_widget', $view_display, array(13));
      break;
  }
  return $block;
}


/**
 * Theme function for table view
 
function theme_reach_slideshow_panel_widget($variables) {
  dpm($variables);
  
  /*$title = $variables['items']['title'];
  $description = $variables['items']['description'];
  $image_entity = entity_uuid_load('file', array($variables['items']['uuid']));
  $image = file_load(array_pop($image_entity)->fid);
  $link = $variables['items']['link'];

  $output = '<div id="' . 'panopoly-spotlight-' . $variables['delta'] . '" class="' . 'panopoly-spotlight' . '">';
  $output .= theme('image_style', array('style_name' => 'panopoly_image_spotlight', 'path' => $image->uri));
  $output .= '<div class="panopoly-spotlight-wrapper">';
  $output .= '<h3 class="panopoly-spotlight-label">' . t('Spotlight') . '</h3>';
  $output .= '<div class="panopoly-spotlight-info">';
  $output .= '<h2>' . l($title, $link) . '</h2>';
  $output .= '<p>' . $description . '</p>';
  $output .= '</div>';
  $output .= '</div>';
  $output .= '</div>';

  return $output;
}*/



